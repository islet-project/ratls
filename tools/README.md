# RaTls tools

* [ratls-serve](./ratls-serve) contains a simple HTTPS server with RA-TLS
* [ratls-get](./ratls-get) contains a simple HTTPS client with RA-TLS

# General information

See the help for each tool, as most parameters have default values and files are
provided in the directory. Both tools will display the config with the
values they have set (including the ones from defaults) in their logs.

Both tools can run in 3 network modes, first two are provided for testing
purposes:

- `no-tls`: Plain HTTP (no encryption)
- `tls`: Standard HTTPS/TLS with certificate verification
- `ra-tls`: Remote Attestation TLS with token verification (default)

## Server

The cmd line options with defaults are as follows:

- `-r, --root <ROOT>`: runtime server root directory [default: ./root]
- `-c, --cert <CERT>`: path to server certificate [default: ./certs/server.crt]
- `-k, --key <KEY>`: path to server private key [default: ./certs/server.key]
- `-t, --tls <TLS>`: TLS variant to use [default: ra-tls] [possible values: no-tls, tls, ra-tls]
- `-p, --port <PORT>`: server port [default: 1337]
- `-u, --veraison-url <VERAISON_URL>`: RA-TLS: Veraison verification service host [default: https://localhost:8080]
- `-v, --veraison-pubkey <VERAISON_PUBKEY>`: RA-TLS: Veraisons public key [default: ./ratls/pkey.jwk]
- `-j, --reference-json <REFERENCE_JSON>`: RA-TLS: JSON containing reference values [default: ./ratls/example.json]

The last three options make sense only for RA-TLS.

The server also has two features to help with testing. They are NOT to be
enabled in production environment:

- `disable-challenge`: When RA-TLS is used the token returned from the client is
  supposed to have a challenge equal to the one that was sent by the server in
  the request. When testing with dummy token this is impossible to achieve so
  this feature disables the check.
- `disable-veraison`: Disables the Veraison verifier altogether. Allows to test
  without Veraison configured and running.

## Client

The cmd line options with defaults are as follows:

- `-r, --root-ca <ROOT_CA>:` Root certificate file in PEM format (used with tls and ra-tls) [default: ./certs/root-ca.crt]
- `-u, --url <URL>`: URL of the file to download, omit the protocol [default: localhost:1337/example.txt]
- `-d, --dir <DIR>`: Directory to save the downloaded file [default: .]
- `-t, --tls <TLS>`: TLS variant to use [default: ra-tls] [possible values: no-tls, tls, ra-tls]
- `-f, --token <TOKEN>`: Use dummy token from file (useful for testing)

If the address/url to get ends with `/` (e.g. `192.168.10.1:1337/` or
`192.168.10.1:1337/test/`) directory listing will be returned as simple JSON and
the client will print the response in the log. No files will be saved.

# Running on the host/localhost

## Server

We need to disable challenge verification as the token (client side) comes from
a file and its challenge surely doesn't match the one randomly generated by
server.

```sh
cd ratls-serve
cargo run --features disable-veraison,disable-challenge -- -h
cargo run --features disable-veraison,disable-challenge --
```

## Client

When the client is run on the host it cannot perform a CCA attestation so we
need to pass an example token instead (that would normally be obtained through
said attestation).

```sh
cd ratls-get
cargo run -- -h
cargo run -- -f ratls/token.bin -u localhost:1337/
cargo run -- -f ratls/token.bin -u localhost:1337/example.txt
cargo run -- -f ratls/token.bin -u localhost:1337/test/
cargo run -- -f ratls/token.bin -u localhost:1337/test/test.txt
```

# Running in the realm

## Server

It will still be run on the host, outside of realm to emulate a remote server.

Veraison can be disabled for testing. If not, it needs to be running and
properly provisioned. See
[here](https://github.com/islet-project/islet/blob/main/examples/veraison/RUN.md).

The realm provisioning file needs to present with proper realm RIM (see
[ratls/example.json](ratls-serve/ratls/example.json)).

```sh
cd ratls-serve
cargo run --features disable-veraison -- -j ratls/test.json
```

## Client

Client will run in the realm. When token file is not passed the client will get
the token through attestation RSI API using the challenge passed from the
server. When a different IP than one below (default for Islet) is used a server
certificate needs to modified.

Host:
```sh
cd ratls-get
cargo build --release --target aarch64-unknown-linux-gnu
cp certs/root-ca.crt $ISLET/out/shared
cp ../../target/aarch64-unknown-linux-gnu/release/ratls-get $ISLET/out/shared/bin
```

Realm (inside `/shared`). It needs to be properly configured (date, network, rsi.ko):
```sh
./bin/ratls-get -r root-ca.crt -u 192.168.10.1:1337/
./bin/ratls-get -r root-ca.crt -u 192.168.10.1:1337/example.txt
./bin/ratls-get -r root-ca.crt -u 192.168.10.1:1337/test/
./bin/ratls-get -r root-ca.crt -u 192.168.10.1:1337/test/test.txt
```
